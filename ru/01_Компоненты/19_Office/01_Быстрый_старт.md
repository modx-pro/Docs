В качестве быстрого старта мы настроим личный кабинет пользователя с авторизацией, редактированием профиля и выводом заказов из [miniShop2][0].

## Авторизация
Личный кабинет будет доступен только для авторизованных пользователей. Их мы будем регистрировать в группу **Users**.

Нужно её создать:

[![](https://file.modx.pro/files/7/a/7/7a777c495c0e0abccc46e79525725c62s.jpg)](https://file.modx.pro/files/7/a/7/7a777c495c0e0abccc46e79525725c62.png)
[![](https://file.modx.pro/files/6/5/5/655a16c9aa7e36db7e73c6df62411ba8s.jpg)](https://file.modx.pro/files/6/5/5/655a16c9aa7e36db7e73c6df62411ba8.png)

Права доступа на контекст назначаем **Load, List and View**.

Теперь создаём раздел "Личный кабинет" и в нём 2 страницы: "Профиль" и "История заказов". Сам личный кабинет должен быть ссылкой на "Историю заказов" - для удобства:

[![](https://file.modx.pro/files/d/0/1/d017b1210c7b83dd53778d44279e35ecs.jpg)](https://file.modx.pro/files/d/0/1/d017b1210c7b83dd53778d44279e35ec.png)
[![](https://file.modx.pro/files/4/4/9/449cd41a395ab891cd7998aebefa5680s.jpg)](https://file.modx.pro/files/4/4/9/449cd41a395ab891cd7998aebefa5680.png)
[![](https://file.modx.pro/files/8/3/d/83d92d38d78ffaf2a3d1a138bbeb978as.jpg)](https://file.modx.pro/files/8/3/d/83d92d38d78ffaf2a3d1a138bbeb978a.png)

Пока делаем настройки, вывода кабинета в меню лучше выключить. Главное потом - не забыть включить обратно.

Теперь нам нужно закрыть эти страницы для доступа всем, кроме группы **Users**.
Обратите внимание, что мы должны дать группе **(аноним)** доступ **Load only**, чтобы они могли загрузить страницу, проверить права доступа и получить "403 Доступ запрещен".
Если не дать им Load only, то страница для них не будет существовать, и анонимы получат "404 не найдено".

Создаём новую группу ресурсов Office, назначаем ей права и включаем в неё все наши 3 страницы личного кабинета.

[![](https://file.modx.pro/files/3/6/f/36f61755226bcae8e6ff855ece8332a8s.jpg)](https://file.modx.pro/files/3/6/f/36f61755226bcae8e6ff855ece8332a8.png)
[![](https://file.modx.pro/files/b/7/a/b7a38c907e7c6fb0be1731f5c4e80b96s.jpg)](https://file.modx.pro/files/b/7/a/b7a38c907e7c6fb0be1731f5c4e80b96.png)

После этого нужно снова зайти в "Контроль доступа" и ужесточить доступ групп Users и (аноним) к этой группе ресурсов, потому что MODX выставляет не совсем верные права по умолчанию.
Для Users он ставит **Resource**, а для (аноним) **Load, List and View**.

[![](https://file.modx.pro/files/5/1/e/51ee007654944ce323b33386b8ba9bd6s.jpg)](https://file.modx.pro/files/5/1/e/51ee007654944ce323b33386b8ba9bd6.png)
[![](https://file.modx.pro/files/c/d/c/cdc63e9d9701d52d19913a73889548e2s.jpg)](https://file.modx.pro/files/c/d/c/cdc63e9d9701d52d19913a73889548e2.png)

Всё, теперь можно открыть страницу кабинета из анонимного режима браузера (мы не должны быть залогинены в админке, это даёт нам дополнительные права) и получить вывод главной страницы по этому адресу.

Чтобы вместо главной нам показывалась страница авторизации, нужно её создать и указать её id в системной настройке **unauthorized_page**.

[![](https://file.modx.pro/files/8/1/a/81aab317054bca52864f5710294f25d1s.jpg)](https://file.modx.pro/files/8/1/a/81aab317054bca52864f5710294f25d1.png)
[![](https://file.modx.pro/files/4/8/7/48794e4f2161f9c70f033e611893d2d3s.jpg)](https://file.modx.pro/files/4/8/7/48794e4f2161f9c70f033e611893d2d3.png)

И теперь в анонимном режиме мы получаем требование авторизации при переходе в личный кабинет:

[![](https://file.modx.pro/files/6/d/9/6d974b4865574dbbbdc49eb418e53069s.jpg)](https://file.modx.pro/files/6/d/9/6d974b4865574dbbbdc49eb418e53069.png)

Обратите внимание, что я вызываю сниппет **officeAuth** с параметром **groups** - это указывает, что пользователя нужно зарегистрировать в группу Users, которая как раз и имеет доступ к личному кабинету.
```
[[!officeAuth?
	&groups=`Users`
]]
```

Всё просто и логично, если немного разобраться. Настроить авторизацию через **HybridAuth** вы можете с помощью [документации][1].
Если она не нужна, то можно её просто отключить:
```
[[!officeAuth?
	&groups=`Users`
	&HybridAuth=`0`
]]
```
Лично я предпочитаю настраивать - это удобно для посетителя.

Все параметры сниппета авторизации можно посмотреть на его странице:

[![](https://file.modx.pro/files/f/e/d/fed7f52fd400888f23a61a7d61af7b1as.jpg)](https://file.modx.pro/files/f/e/d/fed7f52fd400888f23a61a7d61af7b1a.png)

По умолчанию, при регистрации пользователя нельзя использовать HybridAuth.
Юзер должен первый раз авторизоваться через email, а затем уже привязать нужные соцсети в настройках профиля.

Кстати говоря, если покупатель уже оформлял заказ на этот email в miniShop2, то он уже зарегистрирован в системе, и она его не примет.
Но тогда пользователь может сбросить пароль, получить его на почту, войти в личный кабинет и увидеть все свои заказы.

То есть, установкой данного дополнения вы откроете **всем** своим покупателям доступ к их сохранённой истории заказов.

## Редактирование профиля
Основных отличий сниппета **officeProfile** от других решения для редактирования профиля несколько:
* Он целиком и полностью работает через  ajax.
* Он позволяет указать поля профиля, которые можно заполнять.
* Он может требовать определённые поля для заполнения
* Юзер может менять свой username и email. Причем для смены последнего высылается ссылка для активации на новый ящик. Пока юзер не кликнет - email не изменится.
* Можно выводить и редактировать поле **extended** профиля. Такие поля разрешаются в настройках и выводятся в форме как **extended[имя поля]**.
* Юзер может загрузить\удалить картинку для своего профиля, по прежнему через ajax. Если картинки нет - выводится [gravatar][2].
* Здесь юзер может привязать свои соцсети (если включено и настроено), чтобы быстро через них авторизоваться.

Это всё работает сразу, из коробки, безо всякого шаманства.

[![](https://file.modx.pro/files/1/9/a/19ab435142d62ce938dcf4892b4dcf45s.jpg)](https://file.modx.pro/files/1/9/a/19ab435142d62ce938dcf4892b4dcf45.png)

Сам сниппет вызывается очень просто:
```
[[!officeProfile]]
```
Вы можете указать ему дополнительные параметры: отключать ли HybridAuth, куда пересылать юзера при выходе с сайта (по умолчанию - текущий url), параметры загрузки аватара и т.д.
Не буду на этом останавливаться, вы сами можете всё прекрасно посмотреть в его параметрах, в админке.

## Вывод заказов
История заказов вызывается через сниппет **officeMiniShop2**:

[![](https://file.modx.pro/files/d/e/e/dee7bb2e05e4ca5f23188fba7b9d1064s.jpg)](https://file.modx.pro/files/d/e/e/dee7bb2e05e4ca5f23188fba7b9d1064.png)
[![](https://file.modx.pro/files/8/f/e/8fe7aa15248aa16bf8f4509e15093fd5s.jpg)](https://file.modx.pro/files/8/f/e/8fe7aa15248aa16bf8f4509e15093fd5.png)
[![](https://file.modx.pro/files/9/7/d/97d83a9dad06a604428a859f391110fds.jpg)](https://file.modx.pro/files/9/7/d/97d83a9dad06a604428a859f391110fd.png)

Всё построено на ExtJS - это очень удобно. Сам он загружается из установленного MODX, поэтому на разных версиях MODX он может выглядеть немного по разному.

Поля для вывода указываются в системных настройках.
Также вы можете полностью изменить внешний вид ExtJS собственным css файлом, но это довольно кропотливая работа - предупреждаю сразу.

[![](https://file.modx.pro/files/6/f/2/6f2a563d97bbea76516b74dc9c80baads.jpg)](https://file.modx.pro/files/6/f/2/6f2a563d97bbea76516b74dc9c80baad.png)
[![](https://file.modx.pro/files/c/a/1/ca1a88011b00b8c35f17a0858cb9e531s.jpg)](https://file.modx.pro/files/c/a/1/ca1a88011b00b8c35f17a0858cb9e531.png)

Большинству магазинов подойдут настройки по умолчанию, разве что может понадобиться убрать поле "вес".

## Заключение
Теперь вы знаете, как можно очень легко и просто организовать у себя на сайте авторизацию, редактирование профиля и вывод заказов miniShop2.

[0]: /ru/01_Компоненты/02_miniShop2
[1]: /ru/01_Компоненты/04_HybridAuth
[2]: https://gravatar.com