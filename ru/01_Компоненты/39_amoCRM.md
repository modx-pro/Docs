Модуль интеграции сайта на MODX Revolution и системы amoCRM

# Ключевые возможности:

* Из заказа на сайте создает сделку и контакт (или привязывает существующий)
* В свойствах заказа указывается метод оплаты и список товаров
* При смене статуса заказа изменяет статус сделки и наоборот
* Из любой формы обратной связи создает контакт
* Автоматически создает новую воронку для заказов с сайта и статусы заказов в ней
* Автоматически создает дополнительные поля сделок для списка товаров и метода оплаты
* Автоматически создает и обновляет Контакты при сохранении Пользователей на сайте
* Может создавать неограниченное количество дополнительных полей для контактов (упрощенный режим)

# Установка и настройка

## Системные настройки

| Название                       | Значение по умолчанию | Описание                                                                          |
| ------------------------------ | --------------------- | --------------------------------------------------------------------------------- |
| **amocrm_account**             |                       | Аккаунт. Поддомен домена amocrm.ru                                                |
| **amocrm_hash**                |                       | Ключ пользователя, можно получить на странице редактирования профиля пользователя |
| **amocrm_login**               |                       | Логин, с которым вы авторизуетесь в amoCRM                                        |
| **amocrm_new_order_status_id** | 1                     | ID статуса нового заказа minishop2                                                |
| **amocrm_pipeline_id**         |                       | ID воронки для нового заказа, заполняется автоматически при первом заказе         |
| **amocrm_secret_key**          |                       | Секретный ключ виджета                                                            |

Пример заполнения настроек показан ниже:

[![](https://file.modx.pro/files/6/9/a/69ad3bcb28fd3789a0398d75503fed2as.jpg)](https://file.modx.pro/files/6/9/a/69ad3bcb28fd3789a0398d75503fed2a.png)

## Как получить значение amocrm_hash

Откройте профиль пользователя, ключ указан в секции "Ваш API"  

[![](https://file.modx.pro/files/1/f/c/1fcef3724ca4a1bb876199c76f040b22s.jpg)](https://file.modx.pro/files/1/f/c/1fcef3724ca4a1bb876199c76f040b22.png)

## Как получить значение amocrm_secret_key

Ввод значения секретного ключа необходим только для создания дополнительных полей с помощью модуля. Если Вы планируете создавать поля самостоятельно, ключ вводить не требуется.

Перейдите в раздел API настроек **amoCRM** (*https://YOUR_DOMAIN.amocrm.ru/settings/dev/*) и добавьте новый виджет, если не создан ранее.  

[![](https://file.modx.pro/files/b/7/e/b7e530d936c3853d26517007528fc12ds.jpg)](https://file.modx.pro/files/b/7/e/b7e530d936c3853d26517007528fc12d.png)

В окне ввода кода виджета можно ввести что-то осмысленное, но самое главное, чтобы код оказался уникальным в рамках всего **amoCRM**.

Затем в таблице виджетов скопируйте значение из колонки *"Секретный ключ"* и введите в системную настройку.

[![](https://file.modx.pro/files/f/1/c/f1c68cc16e1e1f596c1306b123cf56fas.jpg)](https://file.modx.pro/files/f/1/c/f1c68cc16e1e1f596c1306b123cf56fa.png)

## Настройка Webhook

Для получения изменений из amoCRM на сайт в блоке **Webhook** введите адрес `<http://stite.ru>/assets/components/amocrm/webhook.php`, заменив `<http://stite.ru>` на URL Вашего сайта.

[![](https://file.modx.pro/files/f/8/c/f8cc515579f8ba122c7ae846d8698b81s.jpg)](https://file.modx.pro/files/f/8/c/f8cc515579f8ba122c7ae846d8698b81.png)

После этого в выпадающем списке справа отметьте галочками события:

* Изменить сделку
* Смена статуса сделки

[![](https://file.modx.pro/files/b/c/3/bc3d6226748b6d168f1797b7f03665ffs.jpg)](https://file.modx.pro/files/b/c/3/bc3d6226748b6d168f1797b7f03665ff.png)

## Добавление дополнительных полей Контактам

При создании или изменении Контакта с сайта могут передаваться любые данные Пользователя. Единственное условие - должны быть созданы соответствующие дополнительные поля.
Если секретный ключ виджета указан, то новые поля можно создать прямо с сайта. Для этого удобнее всего использовать компонент **Console** и выполнить в нем следующий код:

```php
if (!$amo = $modx->getService('amocrm', 'amoCRM', $modx->getOption('amocrm_core_path', null,
        $modx->getOption('core_path') . 'components/amocrm/') . 'model/amocrm/', array())
) {
    return 'Could not load amoCRM class!';
}
$amo->auth();
$amo->addContactsCustomFields(array('username', 'email', 'phone'));
```

Здесь видно, что перечень полей задается в виде стандартного массива PHP. Важно: поля должны совпадать со свойствами пользователей MODX.

# Создание контактов из любых форм

Данные из любой формы обратной связи, обрабатываемой в FormIt, можно отправлять в amoCRM в качестве новых контактов. Для этого добавьте в вызов FormIt хук **amoCRMAddContact**  
Важно: поля контактов amoCRM должны совпадать с названиями полей формы.

Пример такого вызова:

```php
[[!FormIt?
    &hooks=`amoCRMAddContact`
    &validationErrorMessage=`Пожалуйста, заполните необходимые поля`
    &validate=`phone:required,name:required,email:email:required`
    &successMessage=`Спасибо большое, данные отправлены в amoCRM`
    &form=`tpl.form`
]]
```

# Пример сделки из заказа

Заполнение корзины на сайте

[![](https://file.modx.pro/files/3/1/b/31b0d4f877e2c0083e8cb821dba79c93s.jpg)](https://file.modx.pro/files/3/1/b/31b0d4f877e2c0083e8cb821dba79c93.png)

Сделка появилась в amoCRM

[![](https://file.modx.pro/files/a/b/7/ab7dace627c0fe3e0e08d3e2e424e2d9s.jpg)](https://file.modx.pro/files/a/b/7/ab7dace627c0fe3e0e08d3e2e424e2d9.png)

Детали сделки

[![](https://file.modx.pro/files/2/e/b/2eba103bcae588f9f4ed5ef61e2b4de7s.jpg)](https://file.modx.pro/files/2/e/b/2eba103bcae588f9f4ed5ef61e2b4de7.png)
