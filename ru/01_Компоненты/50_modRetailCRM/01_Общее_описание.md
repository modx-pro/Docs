## modRetailCRM

### Описание

Компонент для интеграции популярного сервиса [RetailCRM][1] с MODX.

Компонент в основном заточен под популярный интернет-магазин miniShop2, но может работать и без него в ручном режиме, поддерживая весь функционал заложенный в [API RetaiCRM][2]

### Состав компонента

- Плагин,  отслеживающий определенные события 
- Ряд системных настроек
- Сниппет icml, формирующий базовую выгрузку для каталога RetailCRM


### Что умеет modRetailCRM из коробки

1. Отслеживать регистрацию новых пользователей (в том числе и скрытую регистрацию при создании заказа miniShop2) и создавать пользователей в RetailCRM
2. Отслеживать создание новых заказов miniShop2 и передавать данных о заказах в RetailCRM
3. Отслеживать изменение статусов заказов в интернет-магазине, и передавать эти изменения в RetailCRM, меняя статус заказа и там.
4. Отслеживать изменения статусов заказов в RetailCRM и менять статусы этих заказов в интернет-магазине (Требуется дополнительная настройка на стороне RetailCRM)
5. Работать с формами, отправляя необходимые данные (Требуется подготовка и написание сниппета)

### Какие данные о пользователях передаются в RetailCRM

1. Email
2. Номер телефона
4. Имя
3. Идентификационный номер пользователя в MODX

### Какие данные о заказе передаются в RetailCRM

1. Номер заказа
2. Перечень товаров в заказе, включая цену, наименование, количество, идентификатор товара (для связи с каталогом RetailCRM)
3. Модификации товара на основе компонента msOptionsPrice2 и опции товаров
3. Стоимость и способ доставки
4. Способ оплаты
5. Скидка сформированная компонентом msPromoCode
6. Адрес доставки
7. Общий вес заказа

### Что отслеживает и делает плагин

1. Событие **OnUserSave** - Регистрация новых пользователей.  Данные о новых пользователях передаются в RetailCRM
2. Событие **msOnCreateOrder** - Новые заказы. Данные передаются в RetailCRM
3. Событие **msOnChangeOrderStatus** - Изменение статуса заказа.  Данные об обновленном заказе передаются в RetailCRM
4. Событие **OnMODXInit** - Добавление новых полей к способам Оплаты и Доставки, к статусу Заказа
5. Событие **msOnManagerCustomCssJs** - Добавление новых полей к способам Оплаты и Доставки, к статусу Заказа
6. Событие **OnHandleRequest** - Отлавливает данные из RetailCRM, переданные при помощи триггеров и применяет к соответствующим объектам на сайте (Например меняет статус заказа)
 

### Системные настройки modRetailCRM

| Ключ                       | Описание                                                                                                                                                                        |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| modretailcrm_apiKey        | Ключ API - получить его можно в RetailCRM (**Администрирование** /  **Интеграция** / **Ключи доступа к API**)                                                                   |
| modretailcrm_siteCode      | Символьный код сайта - получить его можно в RetailCRM (**Администрирование** /  **Магазины** / **Ваш магазин**)                                                                 |
| modretailcrm_url           | URL адрес вашей  CRM. Его можно взять прямо из адресной строки                                                                                                                  |
| modretailcrm_log           | Логгирование всех запросов.  Необходимо для отладки                                                                                                                             |
| modretailcrm_sync_statuses | Перечень статусов заказов, необходимый для синхронизации статусов. Через запятую перечисляем все статусы, которые мы хотели бы отслеживать. Например 2, 4  (Оплачен, Выполнен). |
| modretailcrm_custom_customers_class | Дает возможность подключить собственный модуль управления клиентами |
| modretailcrm_custom_orders_class | Дает возможность подключить собственный модуль управления заказами |
| modretailcrm_allow_msoptionsprice | Сообщает об использовании компонента msOptionsPrice2 |


### Предварительная настройка

1. Естественно у вас должен быть аккаунт в RetailCRM.
2. В системных настройках сайта (раздел modretailcrm) Вам нужно обязательно указать

* API ключ.
* адрес вашей CRM.
* символьный код сайта.  

3. Доставка.  Для передачи способов доставки при заказе нужно указать их символьные коды
Идем в настройки miniShop2 - открываем по очереди все активные способы доставки - в окне редактирования должно появиться новое поле **Символьный код RetailCRM**
[![](https://file.modx.pro/files/2/d/d/2dd949e3d481748709dc3c6564264c04s.jpg)](https://file.modx.pro/files/2/d/d/2dd949e3d481748709dc3c6564264c04.png)

Записываем туда соответствующий символьный код из справочника доставок RetailCRM. Сохраняем.

[![](https://file.modx.pro/files/1/f/0/1f033d5edefe01dccdfdd87650ebff6cs.jpg)](https://file.modx.pro/files/1/f/0/1f033d5edefe01dccdfdd87650ebff6c.png)

4. Проделываем то же самое со способами оплаты.  Справочник типов оплаты можно найти в разделе Администрирование/Справочники  RetailCRM

5. Проделываем то же самое со статусами заказа. Справочник статусов заказов можно найти в разделе Администрирование/Статусы  RetailCRM

[![](https://file.modx.pro/files/b/f/1/bf1d8c8a63bd888bcdf66a990296c6d7s.jpg)](https://file.modx.pro/files/b/f/1/bf1d8c8a63bd888bcdf66a990296c6d7.png)

6. После этого рекомендуется настроить выгрузку товаров в каталог RetailCRM, Выгрузку существующих пользователей и заказов. По каждому из пунктов есть отдельный раздел документации. Это не обязательное условие для работы, но так вы получите более качественные отчеты и аналитику.

[1]: http://www.retailcrm.ru/?partner=RCI-6419N
[2]: https://www.retailcrm.ru/docs/Developers/ApiVersion5
