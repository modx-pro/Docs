Сниппет реализует вторую половину компонента - фильтрацию найденных результатов.

Обладает огромным количеством настроек и работает, используя свой собственный класс фильтрации, который вы можете расширить.
При небольших знаниях PHP и фантазии, вы можете организовать фильтрацию по любым позициям.

[![](http://st.bezumkin.ru/files/3/a/5/3a53929e0b22f4c3849b9ab6dca71b20s.jpg)](http://st.bezumkin.ru/files/3/a/5/3a53929e0b22f4c3849b9ab6dca71b20.png)

## Параметры

 Название					| По умолчанию					| Описание
----------------------------|-------------------------------|--------------------------------------------------------
**&paginator**				| pdoPage						| Сниппет для постраничной навигации, по умолчанию [pdoPage][1].
**&element**				| mSearch2						| Сниппет, который будет вызываться для вывода результатов работы. По умолчанию - [mSearch2][2].
**&sort**					|  								| Список полей ресурса для сортировки. Указывается в формате «таблица\|поле:направление». Можно указывать несколько полей через запятую, например: «resource:publisedon:desc,ms\|price:asc».
**&filters**				| resource\|parent:parents		| Список фильтров ресурсов, через запятую. Указывается в формате «таблица\|поле:метод».
**&showEmptyFilters**		| true							| Показывать фильтры всего с одним значением.
**&resources**				|  								| Список ресурсов для вывода, через запятую. Этот список будет обработан другими параметрами, такими как **&parents**, **&showDeleted**, **&showHidden** и **&showUnpublished**.
**&parents**				|  								| Список категорий, через запятую, для ограничения вывода результатов.
**&depth**					| 10							| Глубина поиска ресурсов от каждого родителя.
**&tplOuter**				| tpl.mFilter2.outer			| Чанк оформления всего блока фильтров и результатов.
**&tplFilter.outer.default**| tpl.mFilter2.filter.outer		| Стандартный чанк оформления одной группы фильтров.
**&tplFilter.row.default**	| tpl.mFilter2.filter.checkbox	| Стандартный чанк оформления одного фильтра в группе. По умолчанию выводится как checkbox.
**&showHidden**				| true							| Показывать ресурсы, скрытые в меню.
**&showDeleted**			| false							| Показывать удалённые ресурсы.
**&showUnpublished**		| false							| Показывать неопубликованные товары.
**&hideContainers**			| false							| Скрывать ресурсы-контейнеры.
**&showLog**				| false							| Показывать дополнительную информацию о работе сниппета. Только для авторизованных в контекте «mgr».
**&suggestions**			| true							| Этот параметр включает предположительное количество результатов, которое показывается возле каждого фильтра. Отключите, если вы недовольны скоростью фильтрации.
**&suggestionsMaxFilters**	| 200							| Максимальное количество фильтров, для которых работают предварительные результаты. Если фильтров будет больше - **suggestions** отключатся.
**&suggestionsMaxResults**	| 1000							| Максимальное количество ресурсов, для которых работают предварительные результаты. Если ресурсов будет больше - **suggestions** отключатся.
**&suggestionsRadio**		|  								| Список фильтров-радиокнопок, через запятую. Предсказания этих групп фильтров не суммируются между собой. Например: «resource\|class_key,ms\|new»
**&toPlaceholders**			|  								| Если не пусто, mFilter2 сохранит все данные в плейсхолдеры: `[[+filters]]`, `[[+results]]` и `[[+total]]` с префиксом, указанным в этом параметре. Например, если вы указжете **&toPlaceholders=\`my.\`**, то получите: `[[+my.filters]]`, `[[+my.results]]` и `[[+my.total]]`
**&toSeparatePlaceholders**	|  								| Работает так же как и **&toPlaceholders**, только в раздельные плейсхолдеры попадает еще и **filters**. Например, усли вы укажите **&toSeparatePlaceholders=\`my.\`** и **&filters=\`tv\|test,resource\|pagetitle\`** то получите плейсхолдеры `[[+my.results]]`, `[[+my.total]]`, `[[+my.tv|test]]` и `[[+my.resource|pagetitle]]`.
**&filter_delimeter**		| \|							| Разделитель кодового имени таблицы и поля фильтра.
**&method_delimeter**		| :								| Разделитель полного имени фильтра и метода его обработки.
**&values_delimeter**		| ,								| Разделитель значений фильтров в адресной строке сайта.
**&tpls**					|  								| Список чанков для оформления строк, через запятую. Вы можете переключать их указанием в $_REQUEST параметра **&tpl**. 0 - это чанк по умолчанию, а дальше по порядку. Например: **&tpls=\`default,chunk1,chunk2\`**, для вывода товаров чанком "chunk1", нужно прислать в запросе `$_REQUEST[tpl] = 1`.
**&forceSearch**			| false							| Обязательный поиск для вывода результатов. Если нет поискового запроса - ничего не выводится.


## Принцип работы
При первом запуске на странице сниппет получает нужные для фильтрации ресурсы, которые можно указать ему двумя способами:

* Прямое указание параметров, таких как **&parents**, **&resources**, **&showHidden** и т.д. Они будут переданы в сниппет, указанный в **&element** и он вернёт нужные id.
* Поиск по алгоритму mSearch2, если в `$_REQUEST[&queryVar]` что-то есть. При этом, найденные id также пройдут проверку указанными параметрами.

Затем сниппет смотрит настройки фильтров и генерирует данные для них. После чего сохраняет настройки в сессию (для ajax запросов) и выводит оформленные чанки.

Дальше вы кликаете по фильтрам, скрипты ловят их изменение, отправляют запрос на сервер и обновляют содержимое страницы.
Всё полностью автоматизированно, вам нужно только указать верные параметры и настроить чанки.

## Скрипты и стили
При работе mFilter2 регистрируются скрипты и стили, указанные в системных настройках:

* **mse2_frontend_js** - стандартный javascript, по умолчанию `/assets/components/msearch2/js/web/default.js`
* **mse2_frontend_css** - стандартные css стили оформления, по умолчанию `/assets/components/msearch2/css/web/default.css`

Если вы хотите внести какие-то изменения в стандартные файлы, нужно их переименовать и указать новые значения в системных настройках, иначе все ваши изменения будут перезаписаны при очередном обновлении.

#### Особенности
* Для правильной работы необходимо, чтобы все элементы фильтра располагались в одном блоке с `#mse2_mfilter`. Именно так прописано с стандартном чанке **tpl.mFilter2.outer**.
* Скрипт работает через Ajax, сохраняя при этом параметры с адресной строке через HistoryAPI. То есть, у вас всегда есть прямые рабочие ссылки на состояние фильтров.
* Для реализации цифровых слайдеров скрипт использует [jQueryUI.slider][3], который подключается автоматически, если нужен.
* По умолчанию всё оформление рассчитано на [Bootstrap 3][4].
* Стандартная комплектация рассчитана так, чтобы работать при минимальном вызове `[[!mFilter2]]` и установленном Bootstrap 3.
Если у вас что-то "сломалось", после того, как вы изменили чанк - смотрите, что именно вы изменили.

[![](http://st.bezumkin.ru/files/5/6/8/568f372891fb70d76941280929399efds.jpg)](http://st.bezumkin.ru/files/5/6/8/568f372891fb70d76941280929399efd.png)

## Чанки и оформление
У mFilter2 есть один основной чанк, куда выводятся все результаты его работы, с основными плейсхолдерами: `[[+filters]]` и `[[+results]]`.

За результаты отвечают два сниппета: по умолчанию [pdoPage][1], который запускает [mSearch2][2] для вывода собственно строчек с документами.
Вы можете указать и другие сниппеты, например getPage и msProducts:
```
[[!mFilter2?
	&paginator=`getPage`
	&element=`mSearch2`
]]
```

Для каждого чанка можно указать 2 собственных чанка:

* **&tplFilter.outer.таблица\|поле**=`tpl.mFilter2.filter.outer` - чанк-обертка, в который вставляются строки с фильтрами (плейсхолдер `[[+rows]]`).
* **&tplFilter.row.таблица\|поле**=`tpl.mFilter2.filter.checkbox` - чанк для оформления одного параметра фильтра, по умолчанию - это checkbox. В комплекте есть еще и чанк для чисел - его нужно указать самостоятельно.

Например, вызов слайдера для цены товара:
```
[[!mFilter2?
	&class=`msProduct`
	&element=`msProducts`
	&filters=`
		ms|price:number
	`
	&tplFilter.outer.ms|price=`tpl.mFilter2.filter.slider`
	&tplFilter.row.ms|price=`tpl.mFilter2.filter.number`
]]
```

То есть, для каждого параметра фильтра можно указать собственные чанки оформления, а если они не указаны - будут использоваться стандартные.

## Фильтры
Построение фильтров указывается через один параметр **&filters**, в формате `кодовое_имя_таблицы/поле:фильтр`. За один раз можно указать сколько угодно фильтров через запятую.

Соотношение реальных таблиц и кодовых имён:
* **resource** (modResource) - выборка полей ресурса.
* **tv** (modTemplateVar) - выборка ТВ параметров.
* **ms** (msProductData) - выборка полей товара miniShop2, таких как `price`, `article` и др.
* **msoption** (msProductOption) - выборка JSON полей товаров miniShop2, таких как `size`, `color` и др.

Если вы не указываете кодовое имя таблицы, то будет использовано `resource`. А если вы не указываете фильтр, то будет использован `default`.

Пример фильтров в работе:
```
[[!mFilter2?
	&filters=`
		parent:grandparents,
		createdon:year,
		tv|radio:boolean,
		createdby:fullname
	`
]]
```
[![](http://st.bezumkin.ru/files/9/6/3/963d4bc1be1657cdfd657d8fe0ce1e9as.jpg)](http://st.bezumkin.ru/files/9/6/3/963d4bc1be1657cdfd657d8fe0ce1e9a.png)

В комплекте с mFilter2 идёт несколько стандартный методов фильтрации, которые позволяют сделать вывод фильтров более приятным.

#### default
Обычный, стандартный фильтр, рассчитанный на вывод чекбоксов. Применяется ко всем полям, для которых не указан свой фильтр.

#### number
Фильтр для чисел от min до max. При его использовании желательно указывать соответствующие чанки, чтобы вывод был оформлен слайдером.
```
[[!mFilter2?
	&filters=`
		template:number
	`
	&tplFilter.outer.resource|template=`tpl.mFilter2.filter.slider`
	&tplFilter.row.resource|template=`tpl.mFilter2.filter.number`
]]
```
[![](http://st.bezumkin.ru/files/5/7/5/57553cb66b79e1c93391a0ec58bc5f74s.jpg)](http://st.bezumkin.ru/files/5/7/5/57553cb66b79e1c93391a0ec58bc5f74.png)

#### boolean
Фильтр для вывода параметров да\нет. Например, опубликован ли ресурс, скрыт в меню, доступен для поиска и т.д.
Если не указать фильтр `boolean` у таких полей, то вы получите 0 и 1 в значениях. А если указать - то "да" и "нет".
```
[[!mFilter2?
	&filters=`
		isfolder:boolean
	`
]]
```
[![](http://st.bezumkin.ru/files/b/c/0/bc022499933ae06b101e290e9b784a16s.jpg)](http://st.bezumkin.ru/files/b/c/0/bc022499933ae06b101e290e9b784a16.png)

#### parents, categories и grandparents
Следующие три фильтра применяются только к полю *parent* ресурса.

Parents выводит имена двух родителей, через разделитель. Он включен по умолчанию.
```
[[!mFilter2?
	&filters=`
		parent:parents
	`
]]
```
[![](http://st.bezumkin.ru/files/5/b/3/5b39cd5c3019e80fa4d66819f9a2d252s.jpg)](http://st.bezumkin.ru/files/5/b/3/5b39cd5c3019e80fa4d66819f9a2d252.png)

Categories выводит имя непосредственного родителя.

```
[[!mFilter2?
	&filters=`
		parent:categories
	`
]]
```
[![](http://st.bezumkin.ru/files/3/9/0/3907a5749b8d5dd5d7b38965eacd9326s.jpg)](http://st.bezumkin.ru/files/3/9/0/3907a5749b8d5dd5d7b38965eacd9326.png)

Grandparents выводит имена родителей-дедушек и предназначен для больших каталогов. Если "дедушки" нет, то будет выведен непосредственный родитель.
```
[[!mFilter2?
	&filters=`
		parent:grandparents
	`
]]
```
[![](http://st.bezumkin.ru/files/5/5/e/55e5e69063b9580d534b50a03c1acb4fs.jpg)](http://st.bezumkin.ru/files/5/5/e/55e5e69063b9580d534b50a03c1acb4f.png)

#### vendors
Фильтр для вывода имён производителей товаров miniShop2. Применяется только к полю `vendor` таблицы `ms`.
```
[[!mFilter2?
	&where=`{"class_key":"msProduct"}`
	&filters=`
		ms|vendor:vendors
	`
]]
```
[![](http://st.bezumkin.ru/files/8/5/3/85333575318f1fb2e7fe2881eb25559as.jpg)](http://st.bezumkin.ru/files/8/5/3/85333575318f1fb2e7fe2881eb25559a.png)

#### fullname
Этот фильтр выводит полное имя пользователя. Может применяться к любому полю, содержащему id юзера.
```
[[!mFilter2?
	&filters=`
		createdby:fullname
	`
]]
```
[![](http://st.bezumkin.ru/files/f/c/a/fca1f4f3dc12e0bb19ae0d4388f03e4ds.jpg)](http://st.bezumkin.ru/files/f/c/a/fca1f4f3dc12e0bb19ae0d4388f03e4d.png)

#### year
Этот фильтр применяется к полям с датой и выводит год. Можно, например, фильтровать новости по году создания.
```
[[!mFilter2?
	&filters=`
		createdon:year
	`
]]
```
[![](http://st.bezumkin.ru/files/c/1/3/c13c234629cde60be2122e85ee18483as.jpg)](http://st.bezumkin.ru/files/c/1/3/c13c234629cde60be2122e85ee18483a.png)

## Предварительные результаты
Предварительные результаты - это маленькие циферки рядом с каждым фильтром, которые показывают, сколько вы получите результатов, если кликните на него.
[![](http://st.bezumkin.ru/files/6/3/9/639c9da527e3b25fa8c9b00ae64c59c0s.jpg)](http://st.bezumkin.ru/files/6/3/9/639c9da527e3b25fa8c9b00ae64c59c0.png)

При каждом клике это значение пересчитывается для **всех фильтров**, с учетом текущего состояния. То есть, скрипт пробегает по каждому варианту и считает, сколько будет результатов, если его активировать.

То есть, у нас несколько десятков (сотен, тысяч) дополнительных фильтраций. Зачем это нужно?

* Посетитель сразу знает, что получит при клике, и куда лучше кликнуть.
* Позволяет отключать те комбинации фильтра, которые ничего не выведут. То есть, посетитель не увидит "По вашему запросу ничего не найдено".

Функция безусловно приятная и полезная, но очень тяжелая для работы. Она напрямую зависит от количества фильтруемых результатов и параметров фильтров - то есть, сделать так, чтобы она не тормозила вообще нигде, невозможно.
Поэтому, её можно отключить параметром **&disableSuggestions**.

При активации этой опции вы получите максимальную скорость, но циферки рядом с фильтром пропадут.

## Сортировка результатов
mFilter2 умеет сортировать сразу по нескольким полям таблицы.

Формат указания параметра **&sort** очень похож на работу **&filters**:
```
&sort=`
	resource|publishedon:asc
	,resource|createdby:desc
`
```

Тут нужно знать следующее: в зависимости от используемого сниппета вывода результатов, псевдонимы базы данных могут отличаться. Например в mSearch2 ресурсы джоинятся под псевдонимом **modResource**, а в msProducts - как **msProduct**.

Поэтому при работе с [msProducts][5] нужно указывать вот так:
```
&sort=`
	ms_product|publishedon:asc
	,ms_product|createdby:desc
	,ms|price:asc
	,ms_vendor|name:desc
`
```

В [классе фильтров][6] за эту логику отвечает метод **getSortFields()**, который вы можете изменить, как и все остальные.

По умолчанию заданы вот такие соответствия для псевдонимов таблиц:

* **ms** &rarr; Data
* **ms_product** &rarr; msProduct
* **ms_vendor** &rarr; Vendor
* **tv** &rarr; TV
* **resource** &rarr; modResource

Вот что сниппет получит при обработке параметров из последнего примера:
```
`msProduct`.`publishedon` ASC, `msProduct`.`createdby` DESC, `Data`.`price` ASC, `Vendor`.`name` DESC
```

То есть, **&sort** напрямую завязан на сниппет, выбирающий данные, и то, как у него внутри соединены таблицы.
Поэтому, при любых ошибках сортировки нужно смотреть лог работы и проверять системный журнал.


## Лексиконы
Для оформления фильтров используются записи из лексикона.
Если вы добавили новый фильтр и он отображается непонятной длинной надписью на английском - это значит, что её нужно добавить в словарь mSearch2.

[![](http://st.bezumkin.ru/files/5/5/2/552180f6bee53f13c033fb188c622f04s.jpg)](http://st.bezumkin.ru/files/5/5/2/552180f6bee53f13c033fb188c622f04.png)
[![](http://st.bezumkin.ru/files/e/b/b/ebbc79941c98e61692f47d1e8046c721s.jpg)](http://st.bezumkin.ru/files/e/b/b/ebbc79941c98e61692f47d1e8046c721.png)



[1]: /ru/01_Компоненты/01_pdoTools/01_Сниппеты/03_pdoPage.md
[2]: /ru/01_Компоненты/03_mSearch2/01_Сниппеты/01_mSearch2.md
[3]: http://jqueryui.com/slider/
[4]: http://getbootstrap.com/
[5]: /ru/01_Компоненты/02_miniShop2/02_Сниппеты/01_msProducts.md
[6]: /ru/01_Компоненты/03_mSearch2/03_Расширение/01_Методы_фильтрации.md