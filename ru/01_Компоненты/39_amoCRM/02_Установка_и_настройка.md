# Установка и базовая настройка

## Системные настройки

| Название                       | Значен Описание                                                                                                                               |
| ------------------------------ |-----------------------------------------------------------------------------------------------------------------------------------------------|
| **amocrm_account**             | Аккаунт. Поддомен домена amocrm.ru                                                                                                            |
| **amocrm_client_id**                | ID интеграции, можно получить в виджете интеграции                                                                                            |
| **amocrm_client_secret**               | Секрет интеграции, можно получить в виджете интеграции                                                                                        
                                          |
| **amocrm_client_code**          | Код авторизации, можно получить в виджете интеграции                                                                                          |
| **amocrm_form_pipeline_id**          | Заполняется для отправки из форм. Номер воронки в которую планируете отправлять заявки из форм. Можно взять из адресной строки URL            |
| **amocrm_form_status_new**          | Заполняется для отправки из форм. ID статуса указанной выше воронки.  Можно посмотреть в инспекторе кода, выделив колонку статуса.            |
| **amocrm_pipeline_id**          | Заполняется для отправки заказов minishop2. Номер воронки в которую планируете отправлять заявки из форм. Можно взять из адресной строки URL. |
| **amocrm_new_order_status_id**          | Заполняется для отправки  заказов minishop2. ID статуса указанной выше воронки.  Можно посмотреть в инспекторе кода, выделив колонку статуса.            |


## Пошаговая инструкция для работы с новой системой авторизации.
Здесь я буду частично цитировать пошаговую [инструкцию][3] по настройке CRM от самих AMO, так что можно и там почитать.

Откройте профиль пользователя, ключ указан в секции "Ваш API"  
 
**Шаг 1 — Регистрация приложения**

Все начинается с того, что вам необходимо зайти в раздел Интеграции того аккаунта, в котором вы будете осуществлять поддержку интеграции в будущем. Для создания интеграции вам необходимо обладать правами администратора аккаунта


[![](https://www.amocrm.ru/static/assets/developers/files/oauth/create_integration.png?1)](https://www.amocrm.ru/static/assets/developers/files/oauth/create_integration.png?1)

После нажатия на кнопку Создать Интеграцию, в появившейся форме, вам необходимо указать Название интеграции, выбрать требуемые доступы и указать описание. Также необходимо указать Redirect URI – url страницы получения токенов. Здесь указываем адрес главной страницы сайта. Тот адрес что доступен у вас при написании [[++site_url]] — Обязательно сделать это один в один, включая слеш в конце адреса

В статье написано что обязательно наличие SSL, но пока что это не строго. И без https соединения все работает.

Кроме этих пунктов администраторам аккаунта, в котором создана интеграция, будут доступны: id интеграции, секретный ключ интеграции, код авторизации (после включения интеграции).

После заполнения полей вам необходимо нажать Сгенерировать ключ. После этого новая интеграция будет создана и на следующей странице модального окна будут отображены необходимые ключи.

Обратите внимание, что Secret key и Integration ID привязаны к интеграции и будут показаны только в вашем аккаунте разработчика.

Должна получиться следующая картина


[![](https://file.modx.pro/files/3/9/2/392bfac4199bb4bfe716ce8a6148a432.png)](https://file.modx.pro/files/3/9/2/392bfac4199bb4bfe716ce8a6148a432.png)

Ну и заполняем эти данные в системных настройках обновленного компонента AmoCRM

**Обратите внимание — Код авторизации действует только 20 минут**
Нам важно быстро его получить, заполнить и первый раз обратиться к AmoCRM для того чтобы привязаться к интеграции.

Если этого не сделать вовремя — интеграцию придется обновлять, менять коды доступа и проделывать процедуру заново.

**Шаг 2 — Первоначальная авторизация**

Это единственное место в котором мы используем Код авторизации полученный в личном кабинете. Далее он не понадобится.

Как это работает.

При первом запросе в amoCrm (например заказ или отправка контактной формы) компонент пытается авторизоваться. Он отправляет код доступа и если он еще актуален (прошло не более 20 минут с момента получения) мы получаем постоянный код авторизации действующий сутки.

Постоянный код авторизации записывается в кэш и хранится там в течение всего времени жизни сайта. По истечение отведенного срока он автоматически обновляется.

Если вы не успели получить постоянный код за 20 минут — нужно обновить виджет интеграции в AMO и попробовать снова.


# Системные настройки
## Основные
| Название                       | Значение по умолчанию  | Описание                                                                            |
| ------------------------------ | ---------------------- | ----------------------------------------------------------------------------------- |
| **amocrm_use_simple_queue**    | Нет                    | Включить использование очередей [simpleQueue][1]                                    |
| **amocrm_form_as_lead**        | Нет                    | Создавать сделки из данных форм                                                     |
| **amocrm_save_user_in_mgr**    | Нет                    | Включить создание/обновление контактов при сохранении пользователя в админке сайта  |
| **amocrm_save_user_by_profile**| Нет                    | Включить создание/обновление контактов при сохранении профиля пользователя          |

### Пояснения
* **amocrm_use_simple_queue**
 Если включена данная настройка и установлен компонент [simpleQueue][1], вместо отправки данных в реальном времени будет создано задание на отправку и помещено в очередь.
 Для отправки необходимо настроить запуск скрипта _core/components/amocrm/cron/secondlyrunner.php_ ежеминутно.  
 **Пример** записи в планировщике _cron_ на хостинге [MODHOST][2]:
`* * * * * php ~/www/core/components/amocrm/cron/secondlyrunner.php`

* **amocrm_save_user_by_profile**  
 При включении данной настройки отправка данных в amoCRM будет происходить при вызове события _OnUserProfileSave_ при сохранении профиля _$profile_save()_.  
 Поскольку при использовани процессоров или сохранении в админке передача данных происходит на событии _OnUserFormSave_,
 в большинстве случаев включение данной настройки не требуется. Если же ее включить, во многих случаях при одном сохранении пользователя отправка данных может осуществляться дважды. 
  
  Не рекомендуется включать, если нет осознанной необходимости 

## Воронки и статусы

| Название                       | Значение по умолчанию  | Описание                                                                            |
| ------------------------------ | ---------------------- | ----------------------------------------------------------------------------------- |
| **amocrm_new_order_status_id** | 1                      | ID статуса нового заказа minishop2                                                  |
| **amocrm_pipeline_id**         |                        | ID воронки для новой сделка из заказа. Заполняется автоматически при первом заказе  |
| **amocrm_form_pipeline_id**    |                        | ID воронки для новой сделки из формы, заполняется автоматически при первом создании сделки |
| **amocrm_form_status_new**     |                        | ID статуса для новой сделки из формы. Статус должен существовать в воронке, указанной в настройке _amocrm_form_pipeline_id_ |
| **amocrm_auto_update_pipelines**| Нет                   | Автоматически обновлять воронки и статусы для сделок из заказов                    |


## Поля контактов и сделок

| Название                       | Значение по умолчанию  | Описание                                                                                                           |
| ------------------------------ | ---------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **amocrm_form_filled_fields**  |                        | Список обязательно заполненных полей для форм. Если какое-либо поле не заполнено, сделка не будет создана          |
| **amocrm_order_fields**        | weight,delivery_cost,goods                       | Список полей заказа, передаваемых при создании сделки. Список товаров сохраняется в полей _goods_ |
| **amocrm_order_address_fields**| phone,city,street,building,room,comment          | ID воронки для нового заказа, заполняется автоматически при первом заказе                |
| **amocrm_categories_pipelines**| {}                     | Массив для указания особых параметров для воронки, статуса, ответственного на основании категорий товаров в заказе |
| **amocrm_responsible_id_priority_category** | Да        | Включить принудительное применение ответственного и воронки, найденные по категории товаров в заказе               |
| **amocrm_order_properties_element**    | amoCRMFields   | Название массива в свойствах заказа (_properties_), элементы которого заменят значения по умолчанию                |
| **amocrm_user_fields**         |                        | Список полей пользователя, передаваемых при создании/обновлении контакта            |
| **amocrm_user_enum_fields**    | {"phone":"WORK","email":"WORK","телефон":"WORK"} | JSON массив с указанием ENUM полей и их типов             |
| **amocrm_user_readonly_fields**| name                   | Список полей контактов, защищенных от изменения при передаче данных с сайта         |
| **amocrm_skip_empty_fields**   | Да                     | Пропускать поля с пустыми значениями при подготовке данных для передачи в amoCRM    |
| **amocrm_default_responsible_user_id** |                | ID пользователя, назначаемого ответственным по умолчанию. Не совпадает с ID пользователя MODX и ID какого-либо контакта     |
| **amocrm_auto_create_orders_fields**   | Да             | Автоматически создавать отсутствующие в amoCRM поля для сделок (не работает на базовом тарифе)                     |
| **amocrm_auto_create_users_fields**    | Да             | Автоматически создавать отсутствующие в amoCRM поля для контактов (не работает на базовом тарифе)                  |

### Пояснения

* **amocrm_categories_pipelines**  
 JSON-массив для указания ответственного, воронки и статуса на основании категорий товаров, входящих в заказ.  
 **Формат:**  
  ```
    {  
      "40": 
        {  
            "pipeline_id":23456,  
            "status_id":567890,  
            "responsible_user_id": 123453  
        },  
      "39":
        {  
            "pipeline_id":34567,  
            "status_id":87654  
        }  
    }  
  ```
 Поиск происходит по родительским категориям товаров до первого совпадения. Если в заказе есть несколько товаров, для категорий которых указаны особые параметры, использованы будут параметры для первой обнаруженной категории.   

* **amocrm_responsible_id_priority_category**  
 Если настройка включена, то при передаче данных ID ответственного, сохраненного в свойствах заказа, заменяется на ID ответственного, найденного по категориям товаров.   
 Если выключена, указанный в свойствах заказа ответственный будет сохранен.


[1]: https://modstore.pro/packages/utilities/simplequeue
[2]: https://modhost.pro/?msfrom=e0acf53794eabbc780f2a48bea8ec423
[3]: https://www.amocrm.ru/developers/content/oauth/easy-auth
