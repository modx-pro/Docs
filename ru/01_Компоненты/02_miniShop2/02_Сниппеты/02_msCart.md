Сниппет предназначен для вывода корзины покупателя.

## Параметры
### Параметры отображаемых товаров
Параметры, отвечающие за внешний вид отображаемых товаров в корзине.

Название					| Описание
----------------------------|-----------------------------------------------------------------------------------------------------------------------------------------
**&includeTVs**				| Список ТВ параметров для выборки, через запятую. Например: «action,time» дадут плейсхолдеры `[[+action]]`Важно и `[[+time]]`.
**&includeThumbs**			| Список подгружаемых изображений галереи товаров, соответствующий размерам, указанных в настройках источника файлов. Создают аналогичный размеру плейсхолдер. Например: "120х90,320х240" дадут плейсхолдеры `[[+120x90]]` и `[[+320x240]]`.

### Параметры шаблонов
Эти параметры устанавливают чанки, отвечающие за внешний вид всей корзины.

Название					| По умолчанию									| Описание
----------------------------|-----------------------------------------------|------------------------------------------------------------------------------------------
**&tplRow**				    | tpl.msCart.row							    | Чанк оформления единицы товара внутри корзины. Результаты помещаются в плейсхолдер `[[+goods]]`.
**&tplOuter**				| tpl.msCart.outer								| Чанк обертка для всей корзины. Обязательно наличие контейнера с id="msCart". Понимает плейсхолдеры `[[+goods]]`, `[[+total_count]]`, `[[+total_weight]]` и `[[+total_cost]]`.
**&tplEmpty**				| tpl.msCart.empty								| Чанк для отображения пустой корзины.

## Изменение логики обработки корзины
Корзина товаров — это сердце любого магазина. У каждого магазина она может работать по своему, реализуя любую логику заказчика, поэтому, написать что-то универсальное, устраивающее всех — невозможно.

Вы можете переопределить стандартный класс-обработчик корзины, указав взамен свой собственный в системной настройке **ms2_cart_handler_class**.

### Интерфейс
Этот класс инициализируется методом **miniShop2::initialize()**, и обязан реализовывать интерфейс **msCartInterface**.

Обязательные методы интерфейса:

* **initialize** — Инициализирует класс в контекст. Может загружать скрипты и стили.
* **add** — Добавляет товар в корзину, обязателен параметр **id**.
* **remove** — Удаляет товар из корзины, обязателен параметр **key**.
* **change** — Изменение количества товара в корзине, обязательны **key** и **count**.
* **clean** — Полная очистка корзины.
* **status** — Возвращает статус корзины: общую стоимость, вес и количество товаров.
* **get** — Возвращает содержимое корзины, целиком.
* **set** — Перезаписывает содержимое корзины полученным массивом **cart**.

Также, в комплекте идёт стандартный класс **msCartHandler**, который реализует эти методы, плюс добавляет еще парочку своих, для удобного ответа на запросы. Вы можете унаследовать его, или реализовать интерфейс напрямую.

### Работа с msCartHandler

Работа с классом msCartHandler очень проста:
```
$miniShop2 = $modx->getService('minishop2','miniShop2',
	MODX_CORE_PATH . 'components/minishop2/model/minishop2/', $scriptProperties);
if (!($miniShop2 instanceof miniShop2)) return '';

// Инициализируем класс в текущий контекст
$miniShop2->initialize($modx->context->key, $scriptProperties);

print_r($miniShop2->cart->add(5)); // Добавляем товар с id = 5 и печатаем ответ
print_r($miniShop2->cart->get()); // Получаем и распечатываем содержимое корзины
print_r($miniShop2->cart->status()); // Получаем и распечатываем состояние корзины
```

После инициализации класса miniShop2 корзина со всеми методами доступна в **$miniShop2->cart**.

Учитывая, что имя класса берётся из системных настроек, **у каждого контекста может быть своя корзина**.
 
 
**Важно**: Работать с корзиной напрямую нельзя, только через методы класса.
 
 
По умолчанию msCartHandler возвращает все ответы в формате JSON, что можно изменить следующим образом:
```
// Инициализируем класс в текущий контекст
$scriptProperties['json_response'] = 0;
$miniShop2->initialize($modx->context->key, $scriptProperties);
```

#### Параметры msCartHandler:

Название					| По умолчанию									| Описание
----------------------------|-----------------------------------------------|------------------------------------------------------------------------------------------
**json_response**			| да							                | Возвращать ответы в JSON.
**max_count**			    | 1000							                | Максимальное число товаров для добавления за один раз.
**allow_deleted**			| нет						                    | Указывает, добавлять ли в корзину удаленные товары.
**allow_unpublished**		| нет						                    | Указывает, добавлять ли в корзину неопубликованные товары.

#### События msCartHandler:
Класс msCartHandler генерирует следующие события при работе с корзиной:

* **msOnBeforeAddToCart** — получает `product`, `count`, `options` и `cart`.
* **msOnAddToCart** — получает `key` и `cart`.

* **msOnBeforeRemoveFromCart** — получает `key` и `cart`.
* **msOnRemoveFromCart** — получает `key` и `cart`.

* **msOnBeforeChangeInCart** — получает `key`, `count` и `cart`.
* **msOnChangeInCar** — получает `key`, `count` и `cart`.

* **msOnBeforeEmptyCart** — получает `cart`.
* **msOnEmptyCart** — получает `cart`.

Во всех методах присутствует объект **cart** — это сам класс msCartHandler.

Переменная **key** — это ключ элемента корзины. Формируется следующим образом:
```
md5($id . json_encode($data));
// где $id - это идентификатор товара, а $data - массив параметров, присланных при добавлении
```

Переменная **$count** обозначает количество товара. Числовое значение.

#### Примеры
Если мы хотим изменить товар **перед** добавлением, то нужно воспользоваться событием **msOnBeforeAddToCart**, в котором есть объект **$product**:
```
case 'msOnBeforeAddToCart':
	$product->set('new_price', 5555);
	break;
```
— вы можете делать с товаром что угодно, даже сохранить ему новую цену через $product->save();.

Еще в этом событии есть массив **$data** — дополнительные параметры, присланные пользователем при добавлении товара в корзину. Там может быть цвет, размер и вообще, что угодно. Если его изменить, то продукт добавится с изменённым $key.

А теперь меняем цену товара **после** добавления. В этом событии у нас уже нет товара, есть только корзина и ключ:
```
case 'msOnAddToCart':
	$tmp = $cart->get();
	$tmp[$key]['price'] = 1000;
	$cart->set($tmp);	
	break;
```
— таким образом можно менять содержимое корзины при любом событии, **$cart** есть везде.
