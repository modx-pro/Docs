# WebMoney

Компонент для miniShop2, позволяющий производить оплату заказов с помощью сервиса WebMoney.

Чтобы начать принимать платежи с помощью представленного дополнения нужно:

* зарегистрироваться в сервисе **WebMoney** и получить аттестат не ниже формального, подробнее об аттестатах смотрите [здесь][1]
* Создать кошелек соответствующий валюте в которой Вы хотите принимать оплату, и настроить его для приема платежей через **Web Merchant Interface**, эти настройки производятся [здесь][2] <https://merchant.webmoney.ru/conf/purses.asp>
* Установить и настроить компонент
* Внести необходимые изменения на сайт

## Настройка кошелька для приема платежей через Web Merchant Interface

Не буду описывать все параметры, многие понятны без пояснений, обращу ваше внимание лишь на некоторые:

* **Secret Key** обязательно нужен для обеспечения безопасности, Вы можете указать самостоятельно, либо же сервис сам сгенирирует его
* **Secret Key X20** нас не интересует совсем
* **Result URL** укажите `http://ВАШ_САЙТ/assets/components/minishop2/payment/webmoney.php`
* Обязательно поставьте галку **Передавать параметры в предварительном запросе**
* **Success URL** и **Fail URL** можно оставить пустыми, но обязательно переключите **метод вызова Success URL** и **метод вызова Fail UR**, установите им значение **POST**
* Обязательно отметьте галку **Позволять использовать URL, передаваемые в форме**
* **Метод формирования контрольной подписи** установите в **MD5**
* Не забудьте выбрать нужное значение **Тестовый/Рабочий режимы**

Не забудьте сохранить.

## Настройка компонента

После настройки кошелька, нужно настроить компонент для взаимодействия с ним. Для этого перейдите на страницу настроек системы панели управления вашего сайта, пространство имен — **minishop2**, фильтр по разделу — **WebMoney**. В первую очередь нужно указать секретный ключ, из настроек кошелька в параметре **ms_payment_wm_secret** и номер кошелька в параметр **ms_payment_wmid**. Кроме того нужно указать **id** ресурсов на которые будет направлен покупатель после завершения оплаты и в случае ошибки, их можно создать, либо указать **id** ресурса корзины. Если на вашем сайте изменялись статусы заказа, нужно указать **id** статуса **Оплачен** или аналогичного (он будет установлен заказу после завершения оплаты).

## Настройка сайта

Когда всё настройки выполнены, остается внести небольшие изменения на сайте.
Для того, чтобы новый способ оплаты стал доступен покупателям, его нужно активировать и сделать доступным для способов доставки, для которых нужно позволить оплату через WebMoney, это делается в настройках miniShop2.
Для того, чтобы показать покупателю кнопку, которая позволит перейти к оплате, нужно в чанк который отображается ему после оформления заказа сниппетом **msOrder** (по умолчанию это чанк **tpl.msOrder.success**), добавить вызов сниппета **mspWebMoney**.
Если Вы хотите использовать для оповещения покупателя об успешной оплате, или об ошибке отдельные страницы, их нужно создать. Но можно для этих целей использовать и одну страницу — корзину, сниппет **mspWebMoney** предусматривает вывод различных чанков на разных стадиях оплаты, подробнее смотрите в описании сниппета.

## Сниппет mspWebMoney

Сниппет предназначен для формирования кнопки, позволяющей приступить к оплате, а также оповещения покупателя об успешной оплате или ошибке.
Он может принимать всего 3 параметра:

* **succesTpl** — чанк, который будет отображен в случае успешной оплаты. В этом чанке доступен плейсхолдер trans_no — идентификатор транзакции в системе учета WebMoney
* **errorTpl** — чанк, который увидит покупатель, если возникнет ошибка
* **tpl** — чанк кнопки. На самом деле это не просто кнопка, а форма содержащаяя множество скрытых полей, если Вы не знаете наверняка какое из них за что отвечает, лучше не изменяйте ничего, кроме самой кнопки.

[1]: [http://passport.webmoney.ru/asp/WMAtstBasic.asp]
[2]: [https://merchant.webmoney.ru/conf/purses.asp]
