# Товар

Товар miniShop2 является расширением класса обычного ресурса MODX.
Он отличается собственным интерфейсом в системе управления и расширенным набором свойств.

[![](https://file.modx.pro/files/5/4/6/546f08580a43a9a34fca13625666055ds.jpg)](https://file.modx.pro/files/5/4/6/546f08580a43a9a34fca13625666055d.png)

## Основное меню

При создании товара вы можете только сохранить его, или отменить это действие.

А при изменении добавляются еще кнопки просмотра на сайте, копирования и перехода по соседним товарам (если они есть).

## Панель товара

Товар наследует и расширяет стандартную панель ресурса MODX.
Так как разных свойств у него много, все они удобно расположены в отдельном наборе вкладок.

Первой идёт стандартные свойства ресурса:

[![](https://file.modx.pro/files/f/a/0/fa0a70de3b0b4ade9dc823c61ef4bf69s.jpg)](https://file.modx.pro/files/f/a/0/fa0a70de3b0b4ade9dc823c61ef4bf69.png)

Затем настройки ресурса:

[![](https://file.modx.pro/files/5/b/7/5b7c0a87bc2f115ae6321b403c43173ds.jpg)](https://file.modx.pro/files/5/b/7/5b7c0a87bc2f115ae6321b403c43173d.png)

Обратите внимание, что чекбокс "Контейнер" заменяется на "Показывать в меню". Товары не могут быть контейнерами, для этого нужно использовать категории.
Все товары по умолчанию скрываются из меню, чтобы дерево работало быстрее, но вы можете выборочно их показывать с помощью этого переключателя.

Поведение этого переключателя при создании нового товара управляется системной настройкой **ms2_product_show_in_tree_default**.

### Свойства товара

Это специальная вкладка, на которой собраны дополнительные свойства товара, такие как цена, артикул, вес, производитель и т.д.
Свойства товара обязательны и едины для всех.

[![](https://file.modx.pro/files/0/7/b/07bc6a3d032b1df6d562f45eca710a1as.jpg)](https://file.modx.pro/files/0/7/b/07bc6a3d032b1df6d562f45eca710a1a.png)

Набор и порядок вывода полей на этой вкладке управляется системной настройкой **ms2_product_extra_fields**. Доступны по умолчанию:

* **price** - стоимость товара, число до 2х знаков после запятой
* **old_price** - стоимость товара, число до 2х знаков после запятой
* **article** - артикул, можно редактировать как текст
* **weight** - вес товара, число до 3х знаков после запятой
* **color** - массив цветов товара, автосписок
* **size** - массив размеров товара, автосписок
* **made_in** - страна производства товара, обычный текст, с подсказками
* **vendor** - выбор производителя из выпадающего списка
* **tags** - массив тегов товара, автосписок
* **new** - отметка о том, что товар новинка: да \ нет
* **pupular** - отметка о том, что товар популярный: да \ нет
* **favorite** - отметка о том, что товар особенный: да \ нет

Изменить набор доступных свойств можно только через [систему плагинов][1].
Саму вкладку можно скрыть через настройку **ms2_product_tab_extra**.

### Опции товара

Неограниченный список опций, которые наследуются от категории и могут отличаться у разных товаров.

[![](https://file.modx.pro/files/3/4/3/343138dcb7ea9d2ce801d3d6772ad96ds.jpg)](https://file.modx.pro/files/3/4/3/343138dcb7ea9d2ce801d3d6772ad96d.png)

Сами опции создаются в соответствующем разделе настроек магазина и добавляются в настройках категории. Если у категории нет опций, то эта вкладка не выводится.
Также её можно скрыть принудительно, используя настройку **ms2_product_tab_options**.

Подробнее про опции товаров можно прочитать в [соответствующем разделе][2].

### Связи товара

Эта вкладка появляется только при редактировании товара, потому что для её работы должен существовать id товара, который отсутствует на момент его создания.

[![](https://file.modx.pro/files/2/4/1/2417516e02ff308cb1f53f8f883226a0s.jpg)](https://file.modx.pro/files/2/4/1/2417516e02ff308cb1f53f8f883226a0.png)

Доступные связи создаются в настройках магазина. Выключить эту вкладку можно системной настройкой **ms2_product_tab_links**.

### Категории

Каждый товар магазина может находится в нескольких категориях.
У него должна быть одна обязательная категория, прописанная в свойстве **parent**, и могут быть дополнительные - указанные на этой вкладке.

[![](https://file.modx.pro/files/8/2/f/82ffb0c829e766b631bfb056f9f6052cs.jpg)](https://file.modx.pro/files/8/2/f/82ffb0c829e766b631bfb056f9f6052c.png)

Не забудьте сохранить товар при изменении набора категорий! Родную категорию товара из дерева выключить нельзя.

### Комментарии

Эта вкладка выводится только если на сайте установлен компонент [Tickets][3] и включена системная настройка **ms2_product_show_comments**.

[![](https://file.modx.pro/files/5/c/4/5c43f7a822acfe411cfe1eef88f16d92s.jpg)](https://file.modx.pro/files/5/c/4/5c43f7a822acfe411cfe1eef88f16d92.png)

Для того, чтобы посетители могли комментировать ваши товары, нужно вызвать на их страницах сниппет **TicketComments**.

### Галерея

Панель загрузки файлов товара, которая является упрощённой версией платного дополнения [ms2Gallery][4].
В основном используется для загрузки изображений, но может хранить и другие типы файлов, разрешенные в настройках источника медиа.

Появляется только при редактировании товара.

[![](https://file.modx.pro/files/5/c/b/5cb7350a4826a7c3253265279d615a43s.jpg)](https://file.modx.pro/files/5/c/b/5cb7350a4826a7c3253265279d615a43.png)

Основным отличием от аналогов является **генерация превью в момент загрузки** и полный отказ от использования *phpthumbof* и других подобных фильтров вывода.
Это даёт максимальную скорость, поскольку выводятся прямые ссылки на готовые изображения, и позволяет выносить файлы товара на сторонние CDN сервисы (Amazon S3, Selectel Cloud Storage).

[![](https://file.modx.pro/files/a/4/b/a4b89af1ea440c0581e16d0f3aed5930s.jpg)](https://file.modx.pro/files/a/4/b/a4b89af1ea440c0581e16d0f3aed5930.png)

Файлы можно сортировать перетаскиванием, есть контекстное меню и мультивыделение через Ctrl(Cmd) и Shift.

Первая картинка товара является для него основной и выводится на вкладке "Документ".
Ссылки на неё и её превью сохраняются в свойствах `image` и `thumb` товара, чтобы можно было выводить их в каталоге без дополнительных запросов.

У каждого товара есть свой источник файлов (Media source), который управляет параметрами загрузки. Основные свойства:

* **basePath** - путь к директории с файлами товаров. По умолчанию: `assets/images/products/`
* **basePathRelative** - basePath сожет быть указан относительно корня сайта, если включена эта опция.
* **baseUrl** - url директории с файлами товаров, обычно совпадает с *basePath*, если включена *basePathRelative*.
* **baseUrlRelative** - baseUrl может быть указан относительно корня сайта, если включена эта опция.
* **allowedFileTypes** - разрешённые для загрузки типы файлов. По умолчанию только изображения: `jpg,jpeg,png,gif`.
* **imageExtensions** - какие типы файлов являются изображениями. По умолчанию: `jpg,jpeg,png,gif`
* **thumbnailType** - формат файлов превью: JPG или PNG.
* **thumbnailQuality** - качество генерируемого превью, от 0 до 100, где 100 - максимальное качество.
* **skipFiles** - служебные типы файлов, которые не нужно показывать.
* **thumbnails** - настройка генерации картинок-превью в виде JSON массива. Можно указывать любые параметры, которые [примет phpThumb][5].
* **maxUploadWidth** - максимальная ширина изображения. Всё что больше, будет пережато javascript на клиенте, перед загрузкой.
* **maxUploadHeight** - максимальная высота изображения. Всё что больше, будет пережато javascript на клиенте, перед загрузкой.
* **maxUploadSize** - максимальный размер изображения, в байтах.
* **imageNameType** - вид наименования файлов: hash от содержимого, или обработка названия файла алгоритмом генерации friendly имён ресурсов.

При изменении источника медиа товара, уже загруженные файлы в него не скопируются - вам нужно позаботиться об этом самостоятельно.

#### Основные настройки phpThumb

* **w** - ширина превью в пикселях
* **h** - высота превью в пикселях
* **zc** - приблизить и обрезать изображение, чтобы вписать его в заданные *h* и *w*
* **bg** - цвет фона в виде html color hex (ffffff, 000000 и т.п.)
* **far** - подогнать в размеры *h* и *w* без обрезки. Требует указания фона в *bg*
* **q** - качество изображения, от 0 до 100
* **ar** - автоповорот изображения c использованием данных EXIF

Если нужно подгонять изображения только по высоте или ширине, то нужно указывать только *h* или *w*.

``` json
[{"w":120,"q":90,"zc":"1","bg":"000000"},{"h":270,"q":90,"far":"1","bg":"ffffff"}]
```

Остальные параметры смотрите в [документации phpThumb][5].

#### Обновление превью

При изменении настроек источника файлов нужно перегенерировать все превью.

Если товаров немного, то можно сделать это вручную, выбирая нужные картинки и обновляя через контекстное меню
[![](https://file.modx.pro/files/1/8/2/182e6f257fcf683235327edb160c4566s.jpg)](https://file.modx.pro/files/1/8/2/182e6f257fcf683235327edb160c4566.png)

Или вы можете обновить сразу **все картинки** специальным скриптом:

``` php
<?php
define('MODX_API_MODE', true);
require 'index.php'; // Этот файл лежит в корне сайта

$modx->getService('error','error.modError');
$modx->setLogLevel(modX::LOG_LEVEL_ERROR);
$modx->setLogTarget(XPDO_CLI_MODE ? 'ECHO' : 'HTML');

// Проходимся по всем товарам
$products = $modx->getIterator('msProduct', array('class_key' => 'msProduct'));
foreach ($products as $product) {
    // Получаем оригиналы их картинок
    $files = $product->getMany('Files', array('parent' => 0));
    foreach ($files as $file) {
        // Затем получаем их преью
        $children = $file->getMany('Children');
        foreach ($children as $child) {
            // Удаляем эти превью, вместе с файлами
            $child->remove();
        }
        // И генерируем новые
        $file->generateThumbnails();

        // Если это первый файл в галерее - обновляем ссылку на превью товара
        /** @var msProductData $data */
        if ($file->get('rank') == 0 && $data = $product->getOne('Data')) {
            $thumb = $file->getFirstThumbnail();
            $data->set('thumb', $thumb['url']);
            $data->save();
        }
    }
}

echo microtime(true) - $modx->startTime;
```

Так как операция генерации превью может занять длительное время, лучше запускать этот скрипт из консоли сервера.

### Дубликаты

Товары можно копировать, при этом копируются:

* Все свойства документа
* Все настройки документа
* Свойства товара
* Опции товара
* Связи товара
* Категории товара

**Файлы галереи не копируются** просто потому, что это длительная операция, особенно если используется удалённый источник файлов типа Amazon S3, и процесс может отвалиться по таймауту.

[1]: /ru/01_Компоненты/02_miniShop2/03_Разработка/01_Плагины_товаров.md
[2]: /ru/01_Компоненты/02_miniShop2/01_Интерфейс/04_Настройки.md
[3]: /ru/01_Компоненты/15_Tickets
[4]: /ru/01_Компоненты/18_ms2Gallery
[5]: http://phpthumb.sourceforge.net/demo/docs/phpthumb.readme.txt
