# Установка и настройка

## Системные настройки

### Подключение к amoCRM

| Название | Описание |
|----------|----------|
| **amoconnector.enabled** | Глобальный вкл/выкл интеграции |
| **amoconnector.client_id** | ID интеграции (из настроек приложения amoCRM) |
| **amoconnector.client_secret** | Secret интеграции |
| **amoconnector.redirect_uri** | URI перенаправления для OAuth (должен совпадать с настройкой в amoCRM) |
| **amoconnector.subdomain** | Поддомен аккаунта amoCRM (например, `mycompany` для `mycompany.amocrm.ru`) |

### Воронки и статусы

| Название | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| **amoconnector.default_pipeline_id** | | ID воронки для сделок из заказов |
| **amoconnector.default_status_id** | | ID начального статуса сделки |
| **amoconnector.form_pipeline_id** | | ID воронки для сделок из форм. Если пусто — используется воронка по умолчанию |
| **amoconnector.form_status_id** | | ID статуса для сделок из форм |
| **amoconnector.responsible_user_id** | | ID ответственного пользователя в amoCRM |

### Шаблоны и теги

| Название | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| **amoconnector.order_lead_name_tpl** | `Заказ #{num}` | Шаблон названия сделки из заказа. Плейсхолдеры: `{num}`, `{id}` |
| **amoconnector.form_lead_name_tpl** | `Заявка: {form_name}` | Шаблон названия сделки из формы. Плейсхолдер: `{form_name}` |
| **amoconnector.order_tags** | `miniShop2, сайт` | Теги для сделок из заказов (через запятую) |
| **amoconnector.form_tags** | `форма сайта` | Теги для сделок из форм (через запятую) |

### Дополнительные

| Название | Значение по умолчанию | Описание |
|----------|-----------------------|----------|
| **amoconnector.webhook_secret** | | Секретный ключ для верификации webhook. Генерируется автоматически при установке |
| **amoconnector.sync_statuses_from_amo** | `Да` | Обратная синхронизация: смена стадий сделок в amoCRM меняет статусы заказов ms2 |
| **amoconnector.use_scheduler** | `Нет` | Отложенная отправка через Scheduler |
| **amoconnector.log_retention_days** | `30` | Количество дней хранения записей лога |

## Настройка OAuth-авторизации

### Шаг 1 — Создание интеграции в amoCRM

1. Войдите в аккаунт amoCRM с правами администратора
2. Перейдите в **Настройки** → **Интеграции** → **Создать интеграцию**
3. Укажите название, описание и Redirect URI — адрес вашего сайта
4. После создания скопируйте **ID интеграции** и **Секретный ключ**

### Шаг 2 — Заполнение настроек в MODX

Заполните системные настройки `amoconnector.client_id`, `amoconnector.client_secret`, `amoconnector.redirect_uri` и `amoconnector.subdomain`.

### Шаг 3 — Авторизация

Откройте панель управления компонентом (**Приложения** → **amoConnector**) и нажмите кнопку авторизации на вкладке **Настройки**. Вы будете перенаправлены в amoCRM для подтверждения доступа.

После успешной авторизации токены сохраняются автоматически и обновляются по мере необходимости.

## Панель управления (CMP)

Компонент добавляет раздел в меню **Приложения** → **amoConnector** с вкладками:

- **Лог операций** — все отправки, ошибки, пропуски с фильтрацией
- **Маппинг полей** — настройка соответствия полей заказов/форм полям amoCRM
- **Маппинг статусов** — соответствие статусов ms2 стадиям воронок amoCRM
- **Настройки** — авторизация OAuth, проверка соединения
