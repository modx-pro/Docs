# Маппинг статусов

Компонент позволяет настроить соответствие статусов заказов miniShop2 стадиям воронок amoCRM для автоматической синхронизации.

## Панель управления

Маппинг настраивается в CMP: **Приложения** → **amoConnector** → вкладка **Маппинг статусов**.

Каждая запись содержит:

| Поле | Описание |
|------|----------|
| **Статус ms2** | Статус заказа miniShop2 |
| **Воронка amoCRM** | ID воронки (pipeline) в amoCRM |
| **Статус amoCRM** | ID стадии (status) в указанной воронке |
| **Активно** | Вкл/выкл записи маппинга |

## Прямая синхронизация (MODX → amoCRM)

При смене статуса заказа в miniShop2:

1. Компонент проверяет наличие маппинга для нового статуса
2. Если маппинг найден и заказ связан со сделкой — обновляет стадию сделки в amoCRM
3. Если маппинг не найден — операция пропускается без ошибок

::: info
При создании нового заказа начальный статус не обрабатывается маппингом — сделка создается с настройками воронки по умолчанию.
:::

## Обратная синхронизация (amoCRM → MODX)

При включенной настройке **amoconnector.sync_statuses_from_amo** и настроенном webhook:

1. amoCRM отправляет уведомление о смене стадии сделки
2. Компонент находит связанный заказ по таблице `amo_order_link`
3. Ищет обратный маппинг: стадия amoCRM → статус ms2
4. Обновляет статус заказа в miniShop2

## Пример настройки

| Статус ms2 | Воронка amoCRM | Стадия amoCRM |
|------------|----------------|---------------|
| Новый | 12345 | 67890 (Новая заявка) |
| Оплачен | 12345 | 67891 (Оплата получена) |
| Отправлен | 12345 | 67892 (В доставке) |
| Выполнен | 12345 | 142 (Успешно реализовано) |
| Отменен | 12345 | 143 (Закрыто и не реализовано) |

::: tip
ID воронки можно скопировать из адресной строки amoCRM. ID стадий — через инспектор кода, выделив колонку статуса в воронке.
:::
