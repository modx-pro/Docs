# Настройка Webhook

Webhook позволяет получать уведомления от amoCRM об изменениях сделок и синхронизировать статусы заказов.

## Адрес webhook

URL для настройки в amoCRM отображается на вкладке **Настройки** в CMP компонента. Формат:

```
https://site.ru/assets/components/amoconnector/webhook.php?secret=ВАШ_СЕКРЕТ
```

Секретный ключ генерируется автоматически при установке и хранится в настройке **amoconnector.webhook_secret**.

## Настройка в amoCRM

1. Перейдите в **Настройки** → **Интеграции** → ваша интеграция
2. В блоке **Webhook** укажите URL из CMP
3. Отметьте события:
   - Смена статуса сделки

## Обратная синхронизация статусов

При получении webhook о смене стадии сделки:

1. Проверяется секретный ключ
2. Находится связанный заказ ms2 по таблице `amo_order_link`
3. Ищется обратный маппинг стадии amoCRM → статус ms2
4. Обновляется статус заказа

Для работы обратной синхронизации необходимо:

- Настройка **amoconnector.sync_statuses_from_amo** включена
- Настроен маппинг статусов в CMP
- Сайт доступен из интернета по HTTPS

::: warning
Webhook работает синхронно (server-to-server) и не проходит через Scheduler, даже если тот включен. Это сделано намеренно — webhook не влияет на UX пользователей сайта.
:::
