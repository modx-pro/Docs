---
title: –°–æ–±—ã—Ç–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
---
# –°–æ–±—ã—Ç–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

–°–æ–±—ã—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –æ—Ç–ø—Ä–∞–≤–∫–∞, –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞–Ω–∞–ª–æ–≤.

## –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã

MiniShop3 –≤–∫–ª—é—á–∞–µ—Ç –¥–≤–∞ –∫–∞–Ω–∞–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–∑ –∫–æ—Ä–æ–±–∫–∏:

| –ö–∞–Ω–∞–ª | –ö–ª–∞—Å—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-------|----------|
| `email` | `EmailChannel` | –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ MODX modMail |
| `telegram` | `TelegramChannel` | –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Telegram Bot API |

### Email –∫–∞–Ω–∞–ª

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π MODX modMail. –®–∞–±–ª–æ–Ω—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —á–∞–Ω–∫–∏.

### Telegram –∫–∞–Ω–∞–ª

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ Telegram Bot API. –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- `ms3_telegram_bot_token` ‚Äî —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
- `ms3_telegram_manager_chat_id` ‚Äî Chat ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è

::: warning –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
Telegram-–±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –ö–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ—ç—Ç–æ–º—É Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ä–∞–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ Chat ID.
:::

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º —á–µ—Ä–µ–∑ Telegram

–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
1. –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. –ü—Ä–∏–≤—è–∑–∞—Ç—å Telegram-–∞–∫–∫–∞—É–Ω—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∫ –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—é –≤ –º–∞–≥–∞–∑–∏–Ω–µ
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å Chat ID –∫–ª–∏–µ–Ω—Ç–∞

#### –®–∞–≥ 1: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è Chat ID

–°–æ–∑–¥–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ msCustomer –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Chat ID:

```sql
ALTER TABLE modx_ms3_customers ADD COLUMN telegram_chat_id VARCHAR(50) NULL;
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Extra Fields –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö MiniShop3.

#### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞ —Å Deep Linking

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ [Telegram Deep Linking](https://core.telegram.org/bots/features#deep-linking) –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞:

```php
<?php
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏
$customerId = $msCustomer->get('id');
$token = hash('sha256', $customerId . $modx->getOption('ms3_snippet_token_secret'));
$linkCode = base64_encode($customerId . ':' . substr($token, 0, 16));

$botUsername = 'YourShopBot'; // –ò–º—è –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
$telegramLink = "https://t.me/{$botUsername}?start={$linkCode}";
```

#### –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞

–ë–æ—Ç –¥–æ–ª–∂–µ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `start` –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å Chat ID:

```php
<?php
// Webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–æ—Ç–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä)
$update = json_decode(file_get_contents('php://input'), true);
$message = $update['message'] ?? null;

if ($message && str_starts_with($message['text'], '/start ')) {
    $linkCode = substr($message['text'], 7);
    $decoded = base64_decode($linkCode);
    [$customerId, $tokenPart] = explode(':', $decoded);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
    $expectedToken = hash('sha256', $customerId . $modx->getOption('ms3_snippet_token_secret'));
    if (substr($expectedToken, 0, 16) === $tokenPart) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º Chat ID –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∫–ª–∏–µ–Ω—Ç–∞
        $customer = $modx->getObject(\MiniShop3\Model\msCustomer::class, $customerId);
        if ($customer) {
            $customer->set('telegram_chat_id', $message['chat']['id']);
            $customer->save();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            sendTelegramMessage($message['chat']['id'], '‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã!');
        }
    }
}
```

#### –®–∞–≥ 4: –ü–ª–∞–≥–∏–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç—É

```php
<?php
/**
 * –ü–ª–∞–≥–∏–Ω: Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º
 * –°–æ–±—ã—Ç–∏—è: msOnChangeOrderStatus
 */

switch ($modx->event->name) {
    case 'msOnChangeOrderStatus':
        $order = $scriptProperties['order'];
        $newStatus = $scriptProperties['status'];

        // –ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        $customer = $order->getOne('Customer');
        if (!$customer) {
            return;
        }

        $chatId = $customer->get('telegram_chat_id');
        if (empty($chatId)) {
            return; // –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–ª Telegram
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        $statusName = $modx->lexicon($newStatus->get('name'));
        $orderNum = $order->get('num');

        $message = "üì¶ –ó–∞–∫–∞–∑ #{$orderNum}\n";
        $message .= "–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: {$statusName}";

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram API
        $botToken = $modx->getOption('ms3_telegram_bot_token');
        $url = "https://api.telegram.org/bot{$botToken}/sendMessage";

        $ch = curl_init($url);
        curl_setopt_array($ch, [
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => [
                'chat_id' => $chatId,
                'text' => $message,
                'parse_mode' => 'HTML',
            ],
            CURLOPT_RETURNTRANSFER => true,
        ]);
        curl_exec($ch);
        curl_close($ch);
        break;
}
```

#### –®–∞–≥ 5: –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ

–î–æ–±–∞–≤—å—Ç–µ –≤ —à–∞–±–ª–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è –∫–ª–∏–µ–Ω—Ç–∞:

```fenom
{if $customer.telegram_chat_id}
    <div class="alert alert-success">
        <i class="bi bi-telegram"></i> Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
    </div>
{else}
    <a href="{$telegramLink}" class="btn btn-primary" target="_blank">
        <i class="bi bi-telegram"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    </a>
{/if}
```

::: tip –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥
–í–º–µ—Å—Ç–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ —Ä–∞—Å—Å—ã–ª–æ–∫ (SendPulse, Unisender –∏ –¥—Ä.), –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç API –¥–ª—è Telegram –∏ –±–µ—Ä—É—Ç –Ω–∞ —Å–µ–±—è —Ä–∞–±–æ—Ç—É —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.
:::

## msOnBeforeSendNotification

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è **–ø–µ—Ä–µ–¥** –æ—Ç–ø—Ä–∞–≤–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –ü–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `notification` | `NotificationInterface` | –û–±—ä–µ–∫—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| `channel` | `ChannelInterface` | –ö–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `recipient` | `array` | –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è |

### –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

–ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—É—Å—Ç–æ–π –≤—ã–≤–æ–¥, –æ—Ç–ø—Ä–∞–≤–∫–∞ –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–∞:

```php
<?php
switch ($modx->event->name) {
    case 'msOnBeforeSendNotification':
        $notification = $scriptProperties['notification'];
        $recipient = $scriptProperties['recipient'];
        $channel = $scriptProperties['channel'];

        // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–æ—á—å—é
        $hour = (int)date('G');
        if ($hour >= 23 || $hour < 8) {
            $modx->event->output('–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            return;
        }

        // –ó–∞–ø—Ä–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ email
        if (isset($recipient['email'])) {
            $blockedDomains = ['tempmail.com', 'throwaway.com'];
            $domain = substr($recipient['email'], strpos($recipient['email'], '@') + 1);
            if (in_array($domain, $blockedDomains)) {
                $modx->event->output('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–º–µ–Ω email');
                return;
            }
        }
        break;
}
```

### –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

```php
<?php
switch ($modx->event->name) {
    case 'msOnBeforeSendNotification':
        $notification = $scriptProperties['notification'];
        $recipient = $scriptProperties['recipient'];

        // –î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é
        $context = $notification->getContext();
        $context['custom_field'] = 'value';
        $context['sent_at'] = date('Y-m-d H:i:s');

        // –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        if ($recipient['type'] === 'manager' && empty($recipient['email'])) {
            $recipient['email'] = 'default-manager@example.com';
        }
        break;
}
```

---

## msOnAfterSendNotification

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è **–ø–æ—Å–ª–µ** –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—É—Å–ø–µ—à–Ω–æ–π –∏–ª–∏ –Ω–µ—É—Å–ø–µ—à–Ω–æ–π).

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `notification` | `NotificationInterface` | –û–±—ä–µ–∫—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| `channel` | `ChannelInterface` | –ö–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `recipient` | `array` | –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è |
| `success` | `bool` | –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `error` | `string\|null` | –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ –µ—Å—Ç—å) |

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```php
<?php
switch ($modx->event->name) {
    case 'msOnAfterSendNotification':
        $notification = $scriptProperties['notification'];
        $channel = $scriptProperties['channel'];
        $recipient = $scriptProperties['recipient'];
        $success = $scriptProperties['success'];
        $error = $scriptProperties['error'];

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        if ($success) {
            $modx->log(modX::LOG_LEVEL_INFO, sprintf(
                '[Notification] –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: %s ‚Üí %s (%s)',
                get_class($notification),
                $recipient['email'] ?? $recipient['phone'] ?? 'unknown',
                get_class($channel)
            ));
        } else {
            $modx->log(modX::LOG_LEVEL_ERROR, sprintf(
                '[Notification] –û—à–∏–±–∫–∞: %s ‚Üí %s: %s',
                get_class($notification),
                $recipient['email'] ?? $recipient['phone'] ?? 'unknown',
                $error
            ));
        }
        break;
}
```

### –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

```php
<?php
switch ($modx->event->name) {
    case 'msOnAfterSendNotification':
        $success = $scriptProperties['success'];

        if (!$success) {
            $notification = $scriptProperties['notification'];
            $recipient = $scriptProperties['recipient'];

            // –î–æ–±–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            $queue = $modx->newObject('msNotificationQueue', [
                'notification_class' => get_class($notification),
                'notification_data' => json_encode($notification->getContext()),
                'recipient' => json_encode($recipient),
                'retry_count' => 0,
                'scheduled_at' => date('Y-m-d H:i:s', strtotime('+5 minutes')),
            ]);
            $queue->save();
        }
        break;
}
```

---

## msOnRegisterNotificationChannels

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–∞–Ω–∞–ª—ã.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| `manager` | `NotificationManager` | –ú–µ–Ω–µ–¥–∂–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π |

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞

```php
<?php
switch ($modx->event->name) {
    case 'msOnRegisterNotificationChannels':
        /** @var \MiniShop3\Notifications\NotificationManager $manager */
        $manager = $scriptProperties['manager'];

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Telegram –∫–∞–Ω–∞–ª–∞
        $manager->registerChannel('telegram', function($modx) {
            return new MyTelegramChannel($modx);
        });

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Push –∫–∞–Ω–∞–ª–∞
        $manager->registerChannel('push', function($modx) {
            return new MyPushChannel($modx);
        });
        break;
}
```

### –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞

```php
<?php
namespace MyComponent\Notifications;

use MiniShop3\Notifications\Channels\ChannelInterface;
use MiniShop3\Notifications\NotificationInterface;
use MODX\Revolution\modX;

class TelegramChannel implements ChannelInterface
{
    protected modX $modx;
    protected string $botToken;

    public function __construct(modX $modx)
    {
        $this->modx = $modx;
        $this->botToken = $modx->getOption('my_telegram_bot_token');
    }

    public function send(NotificationInterface $notification, array $recipient): bool
    {
        $chatId = $recipient['telegram_id'] ?? null;
        if (!$chatId) {
            return false;
        }

        $message = $notification->toTelegram($recipient);

        $url = "https://api.telegram.org/bot{$this->botToken}/sendMessage";
        $data = [
            'chat_id' => $chatId,
            'text' => $message,
            'parse_mode' => 'HTML',
        ];

        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        $result = curl_exec($ch);
        curl_close($ch);

        return json_decode($result, true)['ok'] ?? false;
    }
}
```

---

## –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä: –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

```php
<?php
/**
 * –ü–ª–∞–≥–∏–Ω: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
 * –°–æ–±—ã—Ç–∏—è: msOnBeforeSendNotification, msOnAfterSendNotification
 */

switch ($modx->event->name) {

    case 'msOnBeforeSendNotification':
        $notification = $scriptProperties['notification'];

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        $modx->eventData['notification_start'] = microtime(true);
        break;

    case 'msOnAfterSendNotification':
        $notification = $scriptProperties['notification'];
        $channel = $scriptProperties['channel'];
        $recipient = $scriptProperties['recipient'];
        $success = $scriptProperties['success'];
        $error = $scriptProperties['error'];

        $startTime = $modx->eventData['notification_start'] ?? microtime(true);
        $duration = round((microtime(true) - $startTime) * 1000, 2);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        $stats = $modx->newObject('msNotificationStats', [
            'notification_type' => get_class($notification),
            'channel' => get_class($channel),
            'recipient_type' => $recipient['type'] ?? 'unknown',
            'success' => $success ? 1 : 0,
            'error' => $error,
            'duration_ms' => $duration,
            'createdon' => date('Y-m-d H:i:s'),
        ]);
        $stats->save();

        // –ê–ª–µ—Ä—Ç –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—à–∏–±–æ–∫
        if (!$success) {
            $errorCount = $modx->getCount('msNotificationStats', [
                'success' => 0,
                'createdon:>=' => date('Y-m-d H:i:s', strtotime('-1 hour')),
            ]);

            if ($errorCount > 10) {
                $modx->log(modX::LOG_LEVEL_ERROR,
                    "[Notifications] ALERT: {$errorCount} –æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å!"
                );
            }
        }
        break;
}
```
